<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Tra cứu Thời khoá biểu</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      display: flex;
      justify-content: center;
      padding: 40px;
      background: linear-gradient(135deg, #f0f7ff, #e6f0fa);
    }

    .container {
      background: #fff;
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      width: 95%;
      max-width: 1100px;
      animation: fadeIn 0.5s ease;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #59a2f0;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ccc;
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      background: #f1f1f1;
      border-right: 1px solid #ccc;
      transition: all 0.3s ease;
    }

    .tab:last-child {
      border-right: none;
    }

    .tab:hover {
      background: #e1e1e1;
    }

    .tab.active {
      background: #007bff;
      color: white;
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    label {
      font-weight: bold;
      margin-right: 8px;
    }

    select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      margin-bottom: 16px;
      outline: none;
      transition: border 0.2s;
    }

    select:focus {
      border-color: #007bff;
      box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 12px;
      font-size: 14px;
      border-radius: 10px;
      overflow: hidden;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #07ad2b;
      color: white;
      font-weight: bold;
      font-size: 15px;
    }

    /* Hàng nền xen kẽ */
    tbody tr:nth-child(even) {
      background: #f9f9f9;
    }

    tbody tr:hover {
      background: #f1f7ff;
    }

    /* Kẻ đậm dưới header */
    table thead tr {
      border-bottom: 3px solid #000;
    }

    /* Kẻ đậm giữa sáng - chiều */
    .afternoon {
      border-top: 3px solid #000;
    }

    /* Animation nhẹ */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Tra cứu Thời khoá biểu</h2>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-target="classTab">Theo lớp</div>
      <div class="tab" data-target="teacherTab">Theo giáo viên</div>
    </div>

    <!-- Tab 1 -->
    <div id="classTab" class="tab-content active">
      <label>Chọn lớp: </label>
      <select id="classSelect"></select>
      <div id="classResult"></div>
    </div>

    <!-- Tab 2 -->
    <div id="teacherTab" class="tab-content">
      <label>Chọn giáo viên: </label>
      <select id="teacherSelect"></select>
      <div id="teacherResult"></div>
    </div>
  </div>
  <script src="data.js"></script>
  <script>
    let schedules = {};   // JSON từ BE
    let teachers = new Set();
    const BE_URL = `https://tkb-be.vercel.app`

    // --- Tabs ---
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.target).classList.add('active');
      });
    });

    // --- Lấy dữ liệu từ BE ---
    async function loadSchedule() {
      try {
        // const res = await fetch(`${BE_URL}/schedule`);
        // const data = await res.json();
        schedules = data;

        // Lấy danh sách lớp
        const classes = Object.keys(schedules);

        // Lấy danh sách giáo viên (loại trùng)
        classes.forEach(cls => {
          const days = schedules[cls];
          Object.keys(days).forEach(day => {
            const sessions = days[day];
            Object.keys(sessions).forEach(sess => {
              sessions[sess].forEach(item => {
                if (item.gv && item.gv.trim()) teachers.add(item.gv.trim());
              });
            });
          });
        });

        // Dropdown lớp
        const selClass = document.getElementById("classSelect");
        selClass.innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join("");
        selClass.addEventListener("change", showScheduleByClass);
        if (classes.length > 0) showScheduleByClass();

        // Dropdown giáo viên (sắp xếp alphabet)
        const selTeacher = document.getElementById("teacherSelect");
        const arrTeachers = Array.from(teachers).sort((a, b) =>
          a.localeCompare(b, "vi", { sensitivity: "base" })
        );
        selTeacher.innerHTML = arrTeachers.map(t => `<option value="${t}">${t}</option>`).join("");
        selTeacher.addEventListener("change", showScheduleByTeacher);
        if (arrTeachers.length > 0) showScheduleByTeacher();

      } catch (err) {
        console.error("Không tải được dữ liệu", err);
      }
    }

    // --- Hiển thị theo lớp ---
    function showScheduleByClass() {
      const cls = document.getElementById("classSelect").value;
      const result = document.getElementById("classResult");
      if (!cls || !schedules[cls]) {
        result.innerHTML = "<p>Chưa có dữ liệu cho lớp này.</p>";
        return;
      }

      const sch = schedules[cls];
      const weekdays = ["Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6"];

      // Tìm số tiết lớn nhất
      let maxTiet = 0;
      weekdays.forEach(day => {
        if (sch[day]) {
          Object.keys(sch[day]).forEach(sess => {
            sch[day][sess].forEach(item => {
              const t = parseInt(item.tiet, 10);
              if (!isNaN(t) && t > maxTiet) maxTiet = t;
            });
          });
        }
      });

      let html = `<h3>Thời khoá biểu lớp ${cls}</h3>`;
      html += `<table><thead><tr><th>Tiết</th>`;
      weekdays.forEach(d => html += `<th>${d}</th>`);
      html += `</tr></thead><tbody>`;

      for (let t = 1; t <= maxTiet; t++) {
        const rowClass = (t === 5) ? "afternoon" : "";
        html += `<tr class="${rowClass}"><td>${t}</td>`;
        weekdays.forEach(day => {
          let cell = "";
          if (sch[day]) {
            Object.keys(sch[day]).forEach(sess => {
              const found = sch[day][sess].find(x => x.tiet == t);
              // if (found) cell = found.gv ? `${found.mon} (${found.gv})` : found.mon;
              if (found) cell = found.gv ? `${found.mon} (${found.gv})` : found.mon;
            });
          }
          html += `<td>${cell}</td>`;
        });
        html += `</tr>`;
      }
      html += `</tbody></table>`;
      result.innerHTML = html;
    }

    // --- Hiển thị theo giáo viên ---
    function showScheduleByTeacher() {
      const teacher = document.getElementById("teacherSelect").value;
      const result = document.getElementById("teacherResult");
      if (!teacher) {
        result.innerHTML = "<p>Chưa có dữ liệu cho giáo viên này.</p>";
        return;
      }

      let teacherSchedule = {};
      const classes = Object.keys(schedules);
      let maxTiet = 0;
      let subjects = new Set();

      // Gom thời khoá biểu của GV
      classes.forEach(cls => {
        const sch = schedules[cls];
        Object.keys(sch).forEach(day => {
          Object.keys(sch[day]).forEach(sess => {
            sch[day][sess].forEach(item => {
              if (item.gv === teacher) {
                if (!teacherSchedule[day]) teacherSchedule[day] = {};
                if (!teacherSchedule[day][sess]) teacherSchedule[day][sess] = [];
                teacherSchedule[day][sess].push({ tiet: item.tiet, mon: item.mon, cls });

                const t = parseInt(item.tiet, 10);
                if (!isNaN(t) && t > maxTiet) maxTiet = t;

                // Lưu môn (trừ HĐTN 2)
                if (item.mon && item.mon !== "HĐTN 2") {
                  subjects.add(item.mon);
                }
              }
            });
          });
        });
      });

      // Xem GV có bao nhiêu môn (không tính HĐTN 2)
      const subjectCount = subjects.size;

      const weekdays = ["Thứ 2", "Thứ 3", "Thứ 4", "Thứ 5", "Thứ 6"];
      let html = `<h3>Thời khoá biểu của GV ${teacher}</h3>`;
      html += `<table><thead><tr><th>Tiết</th>`;
      weekdays.forEach(d => html += `<th>${d}</th>`);
      html += `</tr></thead><tbody>`;

      for (let t = 1; t <= maxTiet; t++) {
        const rowClass = (t === 5) ? "afternoon" : "";
        html += `<tr class="${rowClass}"><td>${t}</td>`;
        weekdays.forEach(day => {
          let cell = "";
          if (teacherSchedule[day]) {
            Object.keys(teacherSchedule[day]).forEach(sess => {
              const found = teacherSchedule[day][sess].find(x => x.tiet == t);
              if (found) {
                if (found.mon === "HĐTN 2") {
                  cell = `${found.cls}`; // chỉ hiển thị lớp
                } else if (subjectCount === 1) {
                  cell = `${found.cls}`; // chỉ hiển thị lớp
                } else {
                  cell = `${found.cls} (${found.mon})`; // lớp + môn
                }
              }
            });
          }
          html += `<td>${cell}</td>`;
        });
        html += `</tr>`;
      }
      html += `</tbody></table>`;
      result.innerHTML = html;
    }

    loadSchedule();
  </script>
</body>

</html>